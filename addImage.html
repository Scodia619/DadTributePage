<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <title>Paul Price's Tribute Page</title>
</head>
<body>
    <div class="nav">
    <ul class="nav nav-tabs nav-justified">
        <li class="nav-item">
          <a class="nav-link" href="index.html">Stories</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="addStory.html">Add Stories</a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="addImage.html">Add Image</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="gallery.html">Gallery</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="login.html">Login</a>
        </li>
      </ul>
    </div>
    <form id="upload-form">
        <input type="file" id="file-input">
        <button type="submit">Upload</button>
    </form>
    <script src="file:///D:/Github/DadTributePage/node-fetch-main/dist/node-fetch.min.js"></script>
    <script src="file:///D:/Github/DadTributePage/form-data-main/lib/browser.js"></script>

    <script>
      var database_length = 0;
    
      function writeToDynamo(link) {
        const id = database_length + 1;
    
        fetch(" https://0xp2quyhph.execute-api.eu-west-1.amazonaws.com/default/postImageCyberman", {
          method: "POST",
          body: JSON.stringify({
            id: id.toString(),
            image_url: link
          }),
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((res) => {
            if (res.ok) {
              console.log(res);
              return res.json();
            }
            throw new Error("Request failed!");
          })
          .then((data) => {
            // window.location.reload();
          })
          .catch((error) => {
            console.error("There was a problem with the fetch operation:", error);
          });
      }
    
      function getLength() {
        fetch('https://iwsiesfgs8.execute-api.eu-west-1.amazonaws.com/default/getAllPhotosCyberman', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("body", JSON.parse(data.body))
            const photos = JSON.parse(data.body);
            database_length = photos.length;
            console.log(database_length);
          })
          .catch((error) => {
            console.error(error);
          });
      }
    
      getLength();
    
      document.getElementById('upload-form').addEventListener('submit', async (event) => {
        event.preventDefault();
    
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
    
        if (file && file.type.startsWith('image/')) {
          await uploadImage(file);
        }
      });
    
      const clientId = 'e00941d8be23862'; // Replace with your actual client ID
    
      async function uploadImage(imageFile) {
        const url = 'https://api.imgur.com/3/upload';
        const headers = new Headers();
        headers.append('Authorization', `Client-ID ${clientId}`);
    
        const formData = new FormData();
        formData.append('image', imageFile);
    
        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: formData
          });
    
          const responseData = await response.json();
          console.log('Image uploaded to Imgur:', responseData.data.link);
          writeToDynamo(responseData.data.link);
        } catch (error) {
          console.error('Error uploading image to Imgur:', error);
        }
      }
    </script>
    
</body>
</html>