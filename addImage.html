<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <title>Paul Price's Tribute Page</title>
</head>
<body>
    <div class="nav">
    <ul class="nav nav-tabs nav-justified">
        <li class="nav-item">
          <a class="nav-link" href="index.html">Stories</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="addStory.html">Add Stories</a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="addImage.html">Add Image</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="gallery.html">Gallery</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="login.html">Login</a>
        </li>
      </ul>
    </div>
    <form id="upload-form">
      <input type="file" id="file-input" accept="image/*" multiple>
      <button type="submit">Upload Images</button>
    </form>    

    <script>
      const clientId = 'YOUR_CLIENT_ID'; // Replace with your actual Imgur client ID
      var database_length = 0;
  
      async function uploadFiles(files) {
        const promises = Array.from(files).map(uploadFile);
        await Promise.all(promises);
      }
  
      async function uploadFile(file) {
        const formData = new FormData();
        formData.append('image', file);
  
        try {
          const response = await fetch('https://api.imgur.com/3/upload', {
            method: 'POST',
            headers: {
              Authorization: `Client-ID ${clientId}`,
            },
            body: formData,
          });
  
          const responseData = await response.json();
          console.log(`Image ${file.name} uploaded to Imgur:`, responseData.data.link);
  
          writeToDynamo(responseData.data.link);
        } catch (error) {
          console.error(`Error uploading ${file.name} to Imgur:`, error);
        }
      }
  
      function writeToDynamo(link) {
        const id = database_length + 1;
  
        fetch("https://0xp2quyhph.execute-api.eu-west-1.amazonaws.com/default/postImageCyberman", {
          method: "POST",
          body: JSON.stringify({
            id: id,
            image_url: link
          }),
          headers: {
            "Content-Type": "application/json",
          },
        })
        .then((res) => {
          if (res.ok) {
            console.log(res);
            return res.json();
          }
          throw new Error("Request failed!");
        })
        .then((data) => {
          // Perform additional actions if needed, e.g., updating UI
        })
        .catch((error) => {
          console.error("There was a problem with the fetch operation:", error);
        });
      }
  
      function getLength() {
        fetch('https://iwsiesfgs8.execute-api.eu-west-1.amazonaws.com/default/getAllPhotosCyberman', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        })
        .then((response) => response.json())
        .then((data) => {
          console.log("body", JSON.parse(data.body));
          const photos = JSON.parse(data.body);
          database_length = photos.length;
          console.log(database_length);
        })
        .catch((error) => {
          console.error(error);
        });
      }
  
      getLength();
  
      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById('upload-form').addEventListener('submit', async (event) => {
          event.preventDefault();
  
          console.log('Form submitted');
  
          await getLength();
  
          const fileInput = document.getElementById('file-input');
          const files = fileInput.files;
  
          if (files.length > 0) {
            console.log(`Uploading ${files.length} files...`);
  
            try {
              await uploadFiles(files);
              console.log('All files uploaded successfully');
  
              // Perform additional actions if needed, e.g., updating UI
            } catch (error) {
              console.error('Error uploading images:', error);
              // Handle error as needed
            }
          } else {
            console.log('No files selected for upload');
          }
        });
      });
    </script>
    
</body>
</html>